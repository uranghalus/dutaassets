generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

//////////////////////////////////////////////////
// USER & AUTH
//////////////////////////////////////////////////

model User {
  id              String  @id
  name            String  @db.Text
  email           String
  emailVerified   Boolean @default(false)
  image           String? @db.Text
  username        String? @db.Text
  displayUsername String? @db.Text
  role            String? @db.Text

  banned     Boolean   @default(false)
  banReason  String?   @db.Text
  banExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  accounts    Account[]
  members     Member[]
  invitations Invitation[]

  /// 1-1 ke Karyawan
  karyawan Karyawan?

  @@unique([email])
  @@index([email(length: 191)])
  @@map("user")
}

model Session {
  id        String   @id
  token     String
  userId    String
  expiresAt DateTime

  ipAddress String? @db.Text
  userAgent String? @db.Text

  activeOrganizationId String? @db.Text
  impersonatedBy       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId(length: 191)], map: "session_userId_idx_custom_v2")
  @@map("session")
}

model Account {
  id         String @id
  userId     String
  providerId String @db.Text
  accountId  String @db.Text

  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "account_userId_idx_custom_v2")
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier(length: 191)], map: "verification_identifier_idx_custom_v2")
  @@map("verification")
}

//////////////////////////////////////////////////
// ORGANIZATION & ACCESS
//////////////////////////////////////////////////

model Organization {
  id   String  @id
  name String  @db.Text
  slug String  @unique
  logo String? @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  members     Member[]
  invitations Invitation[]

  departments       Department[] // ✅ 1 org → banyak department
  organizationRoles OrganizationRole[]
  divisis           Divisi[]
  teams             Team[]

  @@index([deleted_at], map: "organization_deleted_at_idx_custom")
  @@map("organization")
}

model Member {
  id             String @id
  organizationId String
  userId         String
  role           String @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "member_organizationId_idx_custom_v2")
  @@index([userId], map: "member_userId_idx_custom_v2")
  @@index([deleted_at], map: "member_deleted_at_idx_custom_v2")
  @@map("member")
}

model Invitation {
  id             String   @id
  organizationId String
  email          String   @db.Text
  role           String?  @db.Text
  status         String   @db.Text
  expiresAt      DateTime
  inviterId      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "invitation_organizationId_idx_custom_v2")
  @@index([email(length: 191)], map: "invitation_email_idx_custom_v2")
  @@map("invitation")
}

//////////////////////////////////////////////////
// MASTER DATA
//////////////////////////////////////////////////

model Department {
  id_department   String @id @default(uuid())
  organization_id String

  kode_department String @db.Text
  nama_department String @db.Text
  id_hod          String @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  divisis    Divisi[]
  inventorys Inventory[]

  @@unique([organization_id, kode_department(length: 191)], map: "department_org_kode_unique_custom_v2")
  @@index([organization_id], map: "department_organization_id_idx_custom_v2")
  @@index([deleted_at], map: "department_deleted_at_idx_custom_v2")
}

model Divisi {
  id_divisi       String @id @default(uuid())
  department_id   String
  organization_id String

  nama_divisi String @db.Text
  ext_tlp     String @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  department Department @relation(fields: [department_id], references: [id_department], onDelete: Restrict)

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  karyawans   Karyawan[]
  inventories Inventory[]
  teams       Team[]

  @@index([organization_id, department_id], map: "divisi_org_dept_idx_custom_v2")
  @@index([deleted_at], map: "divisi_deleted_at_idx_custom_v2")
}

model Karyawan {
  id_karyawan     String @id @default(cuid())
  organization_id String
  divisi_id       String

  nik             String @db.Char(50)
  nama            String @db.Text
  nama_alias      String
  alamat          String @db.LongText
  no_ktp          String @db.Char(16)
  telp            String @db.Text
  jabatan         String @db.Text
  call_sign       String @db.Char(150)
  status_karyawan String @db.Char(50)
  keterangan      String @db.Char(150)

  userId String? @unique(map: "karyawan_userId_unique_custom_v2")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  divisi_fk Divisi @relation(fields: [divisi_id], references: [id_divisi], onDelete: Restrict)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  inventories Inventory[]

  @@unique([organization_id, nik], map: "karyawan_org_nik_unique_custom_v2")
  @@unique([organization_id, no_ktp], map: "karyawan_org_no_ktp_unique_custom_v2")
  @@index([deleted_at], map: "karyawan_deleted_at_idx_custom_v2")
}

//////////////////////////////////////////////////
// INVENTORY
//////////////////////////////////////////////////

model Inventory {
  id_barang String @id @default(uuid())

  organization_id String
  department_id   String
  divisi_id       String?
  karyawan_id     String?

  kode_barang     String @db.Char(50)
  nama_barang     String @db.Text
  kelompok_barang String @db.Char(100)

  deskripsi_barang      String?   @db.Text
  merk                  String?   @db.Char(100)
  tipe_path_number      String?   @db.Char(100)
  serial_number         String?   @db.Char(100)
  tgl_pembelian         DateTime?
  harga                 Decimal?  @db.Decimal(15, 2)
  tempat_pembelian      String?   @db.Char(100)
  status_kondisi_barang String?   @db.Char(50)
  tempat_lokasi_barang  String?   @db.Char(200)
  tgl_exp_paramsi       DateTime?

  path_folder String? @db.Text
  gambar      String? @db.Text
  expand_data Json?
  keterangan  String? @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  department_fk Department @relation(fields: [department_id], references: [id_department], onDelete: Restrict)

  divisi_fk Divisi? @relation(fields: [divisi_id], references: [id_divisi], onDelete: SetNull)

  karyawan_fk Karyawan? @relation(fields: [karyawan_id], references: [id_karyawan], onDelete: SetNull)

  @@unique([organization_id, kode_barang], map: "inventory_org_kode_unique_custom_v2")
  @@index([organization_id, department_id], map: "inventory_org_dept_idx_custom_v2")
  @@index([deleted_at], map: "inventory_deleted_at_idx_custom_v2")
}

model OrganizationRole {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @db.Text
  permission     String       @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime?    @updatedAt

  @@index([role(length: 191)], map: "organizationRole_role_idx_custom_v2")
  @@map("organizationRole")
}

model Team {
  id_team         String @id @default(uuid())
  organization_id String
  divisi_id       String

  kode_team  String  @db.Text
  nama_team  String  @db.Text
  keterangan String? @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted_at DateTime?

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  divisi       Divisi       @relation(fields: [divisi_id], references: [id_divisi], onDelete: Restrict)

  @@index([organization_id, divisi_id])
  @@index([deleted_at])
}
